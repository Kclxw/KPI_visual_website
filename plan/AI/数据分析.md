下面按你要的格式，把 **AI 分析功能的需求**说清楚：**要实现什么、输入是什么、输出是什么、AI 产出长什么样**，并给出你最急的 **输入数据模板（payload schema）**。我不写提示词。

---

# 1) AI 分析功能要实现什么

## 1.1 功能目标

在 IFIR/RA 的三层分析（Segment / ODM / Model）下，把你已经算好的 **KPI 趋势（row）** 和从 **detail 统计出来的 Top 结构（问题/类型/描述）** 汇总成一个 **可解释的质量诊断摘要**，用于页面 Block C 展示，并可选返回结构化要点供前端渲染。

## 1.2 必须满足的能力

1. **基于证据输出**
   所有结论必须能在输入数据中找到对应证据点（趋势某月变化、Top issue 计数/占比、集中度等）。

2. **同一套输入模板覆盖三层**
   Segment/ODM/Model 只是在 `entity` 与 `top_tables` 的内容不同，但 payload 结构一致，便于后端统一封装和调用。

3. **能解释“是什么 + 为什么可能是这样”**

* 是什么：趋势、Top、集中度、异常月份
* 为什么可能是这样：只能基于 detail 的文本/类型归纳“线索”，不能编造事实

4. **输出可被前端稳定展示**
   输出不仅是一段长文本，还要有结构化字段（标题、要点、证据引用、Top 列表摘要、风险标签等），方便你后续做 UI。

---

# 2) 输入数据是什么（从哪里来）

输入数据由后端在点击 Analyze 后组装，来自两条链路：

## 2.1 KPI 聚合趋势数据（row 表）

* IFIR：来自 IFIR row（BOX CLAIM / BOX MM）
* RA：来自 RA row（RA CLAIM / RA MM）
  用于：
* 月度趋势（Block A）
* 多实体对比（Block D 的饼图/表）
* Top ODM / Top Model（如果该层需要）

## 2.2 结构性问题数据（detail 表）

* IFIR detail / RA detail
  用于：
* Top 问题类型/问题描述（Model 层必需，其他层可选增强）
* 每个 Top 问题提供：计数、占比、月份分布、代表性描述样本（抽样）

> 你的系统里：RA-Model 已明确 Block B 的 Top 问题来自 RA DETAIL，TopN=10，不足则返回全部。

---

# 3) 输出数据是什么（给前端/给日志）

建议输出分两部分：

1. **summary_text**：可直接展示在 Block C 的文字
2. **summary_struct**：结构化结果，便于前端渲染或后续迭代（标签、要点、证据引用、重点问题列表等）

---

# 4) AI 产出应该是什么（你页面看到的样子）

Block C 的 AI Summary 建议固定成以下结构（不管层级都能适配）：

* **Overview**：一句话结论（该实体在本时间段 RA/IFIR 表现如何）
* **Trend Insight**：趋势特征（上升/下降/波动、关键月份、分子分母变化方向）
* **Top Drivers / Top Issues**：Top 结构解读（集中度、Top3 占比、是否长尾）
* **Patterns / Clues**：从问题文本归纳的“场景/复现线索”（仅基于样本描述，标注为线索）
* **Evidence**：列出 3–6 条证据点（对应输入里的具体数值或排名）
* **Need More Data（可选）**：如果缺字段，列出需要的字段名称（不写动作）

---

# 5) 输入数据模板（你最急的 payload schema）

下面给一个 **统一模板**，三层通用。你后端按层级填充即可。

## 5.1 顶层结构

```json
{
  "meta": {
    "kpi": "RA",
    "layer": "MODEL",
    "time_range": { "start_month": "2025-07", "end_month": "2025-12" },
    "trend_months": 6,
    "generated_at": "2026-01-26T10:00:00+09:00",
    "data_as_of": "2025-12"
  },
  "filters": {
    "segment": ["SEG_A"],
    "odm": ["ODM_X"],
    "model": ["MODEL_1", "MODEL_2"]
  },
  "entity": {
    "type": "MODEL",
    "id": "MODEL_1",
    "display_name": "MODEL_1"
  },
  "kpi_definition": {
    "name": "RA",
    "formula_hint": "sum(ra_claim)/sum(ra_mm)",
    "numerator_name": "RA CLAIM",
    "denominator_name": "RA MM",
    "unit": "ratio"
  },
  "series": {
    "monthly_trend": [
      { "month": "2025-07", "kpi": 0.018, "numerator": 18, "denominator": 1000 },
      { "month": "2025-08", "kpi": 0.021, "numerator": 21, "denominator": 1000 }
    ],
    "overall": { "kpi": 0.020, "numerator": 120, "denominator": 6000 }
  },
  "comparisons": {
    "entity_pie": [
      { "entity_id": "MODEL_1", "kpi": 0.020, "share": 0.60, "numerator": 120, "denominator": 6000 },
      { "entity_id": "MODEL_2", "kpi": 0.013, "share": 0.40, "numerator": 80, "denominator": 6200 }
    ]
  },
  "top_tables": {
    "top_models": [],
    "top_odms": [],
    "top_segments": []
  },
  "issues": {
    "source": "RA_DETAIL",
    "issue_field": "Fault_Category",
    "top_n": 10,
    "items": [
      {
        "rank": 1,
        "issue": "Power",
        "count": 42,
        "share": 0.28,
        "month_hist": [
          { "month": "2025-07", "count": 5 },
          { "month": "2025-08", "count": 11 }
        ],
        "examples": [
          { "text": "No power after sleep", "count_hint": 3 },
          { "text": "Cannot boot, black screen", "count_hint": 2 }
        ]
      }
    ]
  },
  "notes": {
    "constraints": [
      "All conclusions must be grounded in provided data",
      "Scenario/repro clues must be derived only from examples.text"
    ]
  }
}
```

---

## 5.2 三层如何复用这个模板（你后端怎么填）

### A) Segment 层

* `entity.type = "SEGMENT"`，`entity.id = segment_name`
* `filters`：segment 多选时，当前卡片是一个 segment，filters 里仍保留“全局选择”
* `top_tables`：填 `top_odms` + `top_models`（来自 row）
* `issues`：可选（如果你不打算在 segment 层做 Top 问题，就让 items=[]）

### B) ODM 层

* `entity.type = "ODM"`，`entity.id = Supplier_NEW`
* `top_tables`：填 `top_models`（来自 row）
* `issues`：可选

### C) Model 层（你当前最明确）

* `entity.type = "MODEL"`，`entity.id = Model`
* `issues.items`：必须填（来自 RA/IFIR DETAIL 的 TopN 问题）
* `top_tables`：一般为空或按你后续需求增加

---

# 6) 输出数据模板（返回给前端的结构）

你后端建议让模型返回这种结构（即使你先只展示 text，结构先保留）：

```json
{
  "summary_text": "....",
  "summary_struct": {
    "overview": "....",
    "trend_insights": [
      { "point": "RA increased in Aug vs Jul", "evidence_ref": ["trend:2025-07", "trend:2025-08"] }
    ],
    "top_drivers": [
      { "item": "Power (28%)", "evidence_ref": ["issue:rank1"] }
    ],
    "patterns_clues": [
      { "clue": "Boot/power related complaints often mention sleep/boot", "evidence_ref": ["issue:rank1:ex1", "issue:rank1:ex2"] }
    ],
    "evidence": [
      { "ref": "trend:2025-08", "value": { "kpi": 0.021, "numerator": 21, "denominator": 1000 } }
    ],
    "data_gaps": [
      { "need": "scenario tag field", "reason": "to confirm usage context beyond text hints" }
    ]
  }
}
```
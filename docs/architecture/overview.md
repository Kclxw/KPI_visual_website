# 系统架构总览

## 1. 系统定位

KPI 可视化分析平台是一个**数据驱动的智能分析系统**，核心能力：

- **实时看板**：多维度 KPI 监控与展示
- **智能下钻**：异常数据快速定位与分析
- **AI 洞察**：自动生成分析报告与改进建议
- **报表导出**：一键生成 PPT/Excel 周报

## 2. 技术架构（分层设计）

```
┌─────────────────────────────────────────────────┐
│              前端展示层 (Vue 3)                   │
│  - Dashboard / Drilldown / Report / AI Panel   │
└─────────────────────────────────────────────────┘
                      ↓ HTTP/REST
┌─────────────────────────────────────────────────┐
│           后端服务层 (FastAPI)                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │   Auth   │  │   KPI    │  │  Report  │      │
│  └──────────┘  └──────────┘  └──────────┘      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ Drilldown│  │  Export  │  │    AI    │      │
│  └──────────┘  └──────────┘  └──────────┘      │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│          异步任务层 (Worker + Celery)             │
│  - AI 分析任务  - 报表导出  - 数据聚合           │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│            数据持久层 (MySQL)                     │
│  - 明细表  - 聚合表  - 配置表  - 审计表          │
└─────────────────────────────────────────────────┘
```

## 3. 核心模块职责

### 3.1 前端层 (frontend/)

**职责**：纯展示与交互，不做业务计算

- 调用后端 API 获取数据
- 渲染图表、表格、卡片
- 处理用户筛选、排序、导出操作
- 管理全局状态（用户、筛选条件、UI）

**技术栈**：Vue 3 + TypeScript + Vite + Pinia + ECharts

### 3.2 后端层 (backend/)

**职责**：系统核心，所有业务逻辑在此

- **口径统一**：KPI 计算逻辑唯一入口
- **权限控制**：接口鉴权与数据权限
- **AI 编排**：证据构建 + 模型调用 + 结构化输出
- **任务调度**：异步任务分发与状态管理
- **审计日志**：记录所有关键操作

**技术栈**：FastAPI + SQLAlchemy + Pydantic + Alembic

### 3.3 异步任务层 (worker/)

**职责**：把耗时操作从 API 请求中剥离

- **AI 分析**：跑大模型推理（可能耗时 10-30 秒）
- **报表导出**：生成 PPT/Excel（可能耗时 5-15 秒）
- **数据聚合**：定时预计算（夜间批处理）

**技术栈**：Celery + Redis

### 3.4 数据层 (MySQL)

**职责**：数据持久化与查询优化

- **kpi_detail**：明细数据（门店/SKU 级）
- **kpi_agg**：聚合数据（预计算加速查询）
- **metric_config**：指标配置（口径、阈值、维度）
- **ai_result**：AI 分析结果（可追溯）
- **audit_log**：操作审计（合规要求）

## 4. 关键设计原则

### 4.1 口径统一

- 所有 KPI 计算逻辑在 `backend/services/` 中
- 前端不做计算，只做格式化展示
- 指标定义存储在 `metric_config` 表

### 4.2 分层解耦

- API 层（路由）只做参数校验与响应封装
- Service 层（服务）负责业务逻辑编排
- Repository 层（仓储）封装数据库操作
- 便于单元测试与功能替换

### 4.3 异步优先

- 耗时操作（AI/导出）立即返回任务 ID
- 前端轮询任务状态或 WebSocket 推送
- 保证 API 响应时间 < 200ms

### 4.4 AI 可控

- 证据包必须来自真实数据（evidence_builder）
- 结构化输出 + 格式校验（guardrails）
- Prompt 版本化管理（可回滚）
- 所有 AI 调用记录到审计日志

## 5. 技术选型理由

| 技术 | 理由 |
|------|------|
| **Vue 3** | 轻量、生态成熟、适合中台系统 |
| **FastAPI** | 异步高性能、自动生成 API 文档、类型安全 |
| **MySQL** | 事务支持、成熟稳定、适合结构化数据 |
| **Celery** | 成熟的任务队列、支持定时任务 |
| **Redis** | 任务队列中间件 + 缓存 |
| **Alembic** | 数据库版本管理，支持灰度发布 |

## 6. 扩展性设计

### 6.1 多租户支持（预留）

- 表结构预留 `tenant_id` 字段
- Repository 层自动添加租户过滤
- 配置支持按租户隔离

### 6.2 模型适配层

- `ai/providers/base.py` 定义统一接口
- 支持 OpenAI / 本地模型 / 其他云服务
- 切换模型不需要改业务代码

### 6.3 数据源扩展

- Repository 层封装数据访问
- 未来支持读取 ClickHouse / Hive 等

## 7. 部署架构

```
        ┌────────┐
        │ Nginx  │  (反向代理 + 静态资源)
        └────────┘
             ↓
    ┌────────┴────────┐
    ↓                 ↓
┌────────┐      ┌──────────┐
│ 前端容器 │      │ 后端容器   │ × N (可水平扩展)
└────────┘      └──────────┘
                      ↓
                ┌──────────┐
                │ Worker   │ × M (按任务量扩展)
                └──────────┘
                      ↓
           ┌──────────┴──────────┐
           ↓                     ↓
       ┌────────┐           ┌────────┐
       │ MySQL  │           │ Redis  │
       └────────┘           └────────┘
```

## 8. 安全设计

- **认证**：JWT Token（过期时间 30 分钟）
- **授权**：基于角色的权限控制（RBAC）
- **审计**：所有写操作记录到 audit_log
- **SQL 注入防护**：使用 ORM 参数化查询
- **敏感信息**：密码哈希存储、配置文件不入库

## 9. 监控与可观测性

- **日志**：结构化日志（JSON 格式）
- **指标**：API 响应时间、任务执行时长
- **告警**：任务失败、数据库连接异常
- **链路追踪**：记录请求 ID 贯穿全链路

---

**更新记录**
- 2026-01-20：初始版本
